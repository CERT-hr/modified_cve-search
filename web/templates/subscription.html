{% extends 'layouts/master-page' %}
{% block title %}Pretplata na CVE liste{% endblock %}
{% block content %}
  <!-- breadcrumb -->
<style>
.invalid {border-color:red;}
#error {color:red}
</style>
<ol class="breadcrumb">
  <li class="active"> Pretplata</li>
</ol>
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Prijava|Pregled|Odjava s liste</h3>
            </div>
  {% if message != None %}
        <div class="alert alert-danger fade in alert-dismissible">{{message}}</div>
  {% endif %}
<div class="choices-wrapper">
<div class="description" style="margin-top: 12px;margin-bottom: 12px;margin-left: 15px;font-weight:bold;">
Molimo vas odabarite jednu od opcija:
</div>
<div class="buttons" style="margin-left: 15px;margin-bottom: 15px;">
                    <button type="button" class="btn btn-primary add-new-button">Pretplata na liste</button>
                    <button type="button" class="btn btn-sm btn-success view-existed-list-button">Pregled postojećih pretplata</button>
                    <button type="button" class="btn btn-sm btn-danger unsubscribe-existed-list-button">Odjava sa pretplata</button>

</div>
</div>
            <div class="add-new-wrapper panel-body" style="display:none">
                <form action="/subscribe" method="post">

                    {{ form.hidden_tag() }}

                    <div class="form-group required">
			<div class="row">
				<div class="col-md-3">
                        		{{ form.email.label }}
                        		{{ form.email(class_="form-control",required='required') }}
				<div id="error"></div>
				</div>
			</div>
                        <div class="subscription-message-wrapper">
			  <label style="padding-top: 20px;">Odaberite kombinaciju proizvođača i njihovih proizvoda za liste ranjivosti na koje se želite preplatiti:</label>
			  <label style="padding-bottom: 20px;">NAPOMENA: Ako ne odaberete proizvod, smatra se da želite preplatu za sve proizvode zadanog proizvođača. U suprotnom odaberite kombinaciju proizvođača i proizvoda po Vašoj želji.</label>
			</div>
			<div class="unsubscription-message-wrapper">
                          <label style="padding-top: 20px;">Odaberite kombinaciju proizvođača i njihovih proizvoda za liste ranjivosti na koje se želite odjaviti:</label>
                        </div>
                        <div class="vendor-product-cvss-header row">
				<div class="col-md-3">Proizvođač</div>
				<div class="col-md-3">Proizvod</div>
				<div class="col-md-3">CVSS<a href="#" title="CVSS(eng. Common Vulnerability Scoring System) predstavlja ocjenu važnosti pojedine objavljene ranjivosti na listi. Unos polja nije obavezan"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></a></div>
			</div>
                        <div class="product-vendor-wrapper" data-toggle="fieldset" id="vendor-product-fields">
                            {% for vpc in form.vpc %}
                            <div class="row" data-toggle="fieldset-entry" style="padding-top:10px;padding-bottom:10px;">
			       <div class="vendor-wrapper col-md-3">{{ vpc.vendorField(class_="form-control vendor") }}</div>
                               <div class="product-wrapper col-md-3">{{ vpc.productField(class_="form-control product") }}</div>
			       <div class="cvss-wrapper col-md-3">{{ vpc.cvssField(class_="form-control cvss") }}</div>
                               <div><button type="button" data-toggle="fieldset-remove-row" id="vendor-product-{{loop.index0}}-remove">-</button></div>
                            </div>
                            {% endfor %}
                        </div>
						<button type="button" data-toggle="fieldset-add-row" data-target="#vendor-product-fields">+</button>
			<input id="vendor-product-number" name="vendor-product-number" type="hidden" value="1">
                        <input id="vendor-product-action" name="vendor-product-action" type="hidden" value="1">
                        {% for error in form.email.errors %}
                        	<span class="label label-danger">{{ error }}</span>
                        {% endfor %}
                    </div>
                    {{ form.submit(class_="btn btn-primary add-subscription") }}
                    <button type="button" class="btn btn-success back-button">Natrag</button>
		    <!--<button type="button" class="btn btn-danger unsubscribe-existed-button">Odjava sa pretplata</button>-->
		    <span class="message"></span>
                </form>
            </div>
<div class="existed-wrapper row" style="display:none;margin-top: 12px;margin-left: 12px;margin-bottom: 15px;">
<div class="col-md-3">
    <label for="email">Upišite Vašu adresu elektroničke pošte</label>
    <input class="form-control" id="email-checker" name="email" required="required" type="text" value="">
    <div id="error"></div>
    <button type="button" class="btn btn-primary view-existed-button" style="margin-top:12px;">Pregled postojećih pretplata</button>
    <button type="button" class="btn btn-success back-button" style="margin-top:12px">Natrag</button>
</div>
<div class="message-box" style="margin-top:31px"></div>
</div>

        </div>
  <script>
  $(document).ready(function(){

$('.add-new-button').click(function(e){
$('.add-new-wrapper').show();
$('.subscription-message-wrapper').show();
$('.choices-wrapper').hide();
$('.unsubscription-message-wrapper').hide();
$('#vendor-product-action').val(1);
$('input#submit').attr('value', 'Pretplata na zadane liste');
});

$('.back-button').click(function(e){
$('.add-new-wrapper').hide();
$('.existed-wrapper').hide();
$('.choices-wrapper').show();
});

$('.view-existed-list-button').click(function(e){
$('.existed-wrapper').show();
$('.choices-wrapper').hide();
});

$('.unsubscribe-existed-list-button').click(function(e){
$('.add-new-wrapper').show();
$('.unsubscription-message-wrapper').show();
$('.choices-wrapper').hide();
$('.subscription-message-wrapper').hide();
$('#vendor-product-action').val(0);
$('input#submit').attr('value', 'Odjava na zadane liste');
});

  
  // Overrides the default autocomplete filter function to search only from the beginning of the string
$.ui.autocomplete.filter = function (array, term) {
    var matcher = new RegExp("^" + $.ui.autocomplete.escapeRegex(term), "i");
    return $.grep(array, function (value) {
        return matcher.test(value.label || value.value || value);
    });
};
       
        $('.cvss').number( true, 1 );

	$( document ).tooltip();

//wrong email format
email.onblur = function() {
var regex = /^[\w\.\+\-]+\@[\w]+\.[a-z]{2,10}$/;

  if($("#email").val()==""){
    email.classList.add('invalid');
    error.innerHTML = 'Molimo unesite adresu elektroničke pošte.'
    return false;
  } else {
	if(!regex.test($("#email").val())){
	  email.classList.add('invalid');
	  error.innerHTML = 'Neispravan format adrese elektroničke pošte.'
	  return false;
	}
  }

};

//remove error, user wants to re enter something
email.onfocus = function() {
  if(this.classList.contains('invalid')){
    this.classList.remove('invalid');
    error.innerHTML = "";
  }
};

var options = {
    source: ["ActionScript", "AppleScript"],
    minLength: 1
};
var autocompleteIsSelect = false;
/*var selector = 'input.vendor';
$(document).on('keydown.autocomplete', selector, function() {
    console.log($(this));
    $(this).autocomplete(options);
});*/   

       $.getJSON( "api/browse", function( data, status, xhr ) {
              $( "input#vpc-0-vendorField" ).autocomplete({
      		source: data["vendor"],
			autoFocus: true,
			change: function(event,ui){
			    console.log($(this));
				$(this).val((ui.item ? ui.item.value : ""));
				$(this).parent().parent().find('input.product').val('');
			},
			response: function(event, ui) {
				if (!ui.content.length) {
						var noResult = { value:"",label:"No results found" };
						ui.content.push(noResult);
				}
			},
			minLength: 1,
      		select: function( event, ui ) {
        		$.getJSON( "api/browse/" + ui.item.value, function( data, status, xhr ) {
				$( "input#vpc-0-productField" ).autocomplete({
					source: data["product"],
					autoFocus: true,
					change: function(event,ui){
						console.log($(this));
						$(this).val((ui.item ? ui.item.value : ""));
					},
					response: function(event, ui) {
						if (!ui.content.length) {
								var noResult = { value:"",label:"No results found" };
								ui.content.push(noResult);
						}
					},
					minLength: 1,
					select: function (e, i) {
                    				autocompleteIsSelect = true;
                    				$("input#vpc-0-productField").val(i.item.label);
						//$('input.product').prop("readonly",true);
                    				console.log('Select-' + autocompleteIsSelect);
                			},
                			close: function (event, ui) {
                    				console.log('Close-' + autocompleteIsSelect);
                    				if (!autocompleteIsSelect) { autocompleteIsSelect = false; $(this).val('');} 
					}
				})
			});
      		}
   	      });

       });

	$( ".view-existed-button" ).click(function() {
	    if($("#email-checker").val().length > 0)
	    {

                var regex = /^[\w\.\+\-]+\@[\w]+\.[a-z]{2,3}$/;

                if(!regex.test($("#email-checker").val())){
                  //email.classList.add('invalid');
                  //error.innerHTML = 'Neispravan format adrese elektroni ^mke po  te.'
                  $('.message').text('');
                  return false;
                }
               	else {

                    $.getJSON( "check_subscription_email/" + $("#email-checker").val(), function( data, status, xhr ) {
                        console.log(data);
                        if(data.email_existed){	
            			$.getJSON( "send-subscription-report/" + $("#email-checker").val(), function( data, status, xhr ) {
					console.log(data);
                			$('.message-box').text('Na zadanu adresu elektroničke pošte je poslana lista na kojima ste trenutno preplaćeni.');
            			});
			}
			else {
				$('.message-box').text('Trenutno niste preplaćeni niti na jednu listu.');	
			}
		    });
		}

		 //$('.message').text('Na zadanu email adresu je poslana lista na kojima ste trenutno preplaćeni');
	    }
            else
	    {
		$('.message-box').text('Adresa elektroničke pošte nije zadana ili nije ispravno upisana.');
	    }

	});

    $( ".unsubscribe-existed-button" ).click(function() {
            if($("#email").val().length > 0)
            {

		var regex = /^[\w\.\+\-]+\@[\w]+\.[a-z]{2,3}$/;

                if(!regex.test($("#email").val())){
                  //email.classList.add('invalid');
                  //error.innerHTML = 'Neispravan format adrese elektroni ^mke po  te.'
                  $('.message').text('');
		  return false;
                }

		else {
			
                    $.getJSON( "check_subscription_email/" + $("#email").val(), function( data, status, xhr ) {
                        console.log(data);
                        if(data.email_existed){
                            if (confirm("  elite li zaista  odjavu sa svih pretplata?")) {
                                $.getJSON( "unsubscribe/" + $("#email").val(), function( data, status, xhr ) {
                                    console.log(data);
                                    $('.message').text('Uspješno ste odjavljeni sa svih lista.');
                                });

                                //$('.message').text('Uspje  no se odjavljeni iz svih lista.');

                            } else {
                                txt = "You pressed Cancel!";
                            }

                        }
                        else {
                            $('.message').text('Trenutno niste preplaćeni niti na jednu listu.');
                        }
                    });

		}
            }
            else
            {
                $('.message').text('Adresa elektroničke pošte nije zadana ili nije ispravno upisana');
            }

        });

	$('.add-subscription').click(function(){
	var regex = /^[\w\.\+\-]+\@[\w]+\.[a-z]{2,10}$/;

	  if($("#email").val()==""){
		email.classList.add('invalid');
		error.innerHTML = 'Molimo unesite adresu elektroničke pošte.'
		return false;
	  } else {
		 if(!regex.test($("#email").val())){
		   email.classList.add('invalid');
		   error.innerHTML = 'Neispravan format adrese elektroničke pošte.'
		   return false;
		  }
		}
	});



  } );
  
  
  $(function () {
   var scntDiv = $('#vendor-product-fields');


    $('button[data-toggle=fieldset-add-row]').on('click', function (e) {
	    var i = $('#vendor-product-fields .row').length;
        e.preventDefault();
        e.stopPropagation();
		var row = '<div class="row" data-toggle="fieldset-entry" style="padding-top:10px;padding-bottom:10px;">' +
			       '<div class="vendor-wrapper col-md-3"><input class="form-control vendor ui-autocomplete-input" id="vpc-' + i + '-vendorField" name="vpc-' + i + '-vendorField" required="" type="text" value="" autocomplete="off"></div>' +
                               '<div class="product-wrapper col-md-3"><input class="form-control product" id="vpc-' + i + '-productField" name="vpc-' + i + '-productField" type="text" value=""></div>' +
			       '<div class="cvss-wrapper col-md-3"><input class="form-control cvss" id="vpc-' + i + '-cvssField" name="vpc-' + i + '-cvssField" type="text" value=""></div>' +
                               '<div><button type="button" data-toggle="fieldset-remove-row" id="vendor-product-' + i + '-remove">-</button></div>' +
                            '</div>';
        $(row).appendTo(scntDiv);
        //return false;

		$('input#vpc-' + (i).toString()  + '-cvssField').number( true, 1 );
		
	    $.getJSON( "api/browse", function( data, status, xhr ) {
	     console.log('Potrazi vendora u kreiranom rowu');
			 console.log('input#vpc-' + (i).toString()  + '-vendorField');
              $('input#vpc-' + (i).toString()  + '-vendorField').autocomplete({
                source: data["vendor"],
				autoFocus: true,
				change: function(event,ui){
					console.log($(this));
					$(this).val((ui.item ? ui.item.value : ""));
					$(this).parent().parent().find('input.product').val('');
				},
				response: function(event, ui) {
					if (!ui.content.length) {
							var noResult = { value:"",label:"No results found" };
							ui.content.push(noResult);
					}
				},
                minLength: 1,
                select: function( event, ui ) {
                        $.getJSON( "api/browse/" + ui.item.value, function( data, status, xhr ) {
                                $('input#vpc-' + (i).toString()  + '-productField').autocomplete({
                                        source: data["product"],
										autoFocus: true,
										change: function(event,ui){
											console.log($(this));
											$(this).val((ui.item ? ui.item.value : ""));
										},										
										response: function(event, ui) {
											if (!ui.content.length) {
													var noResult = { value:"",label:"No results found" };
													ui.content.push(noResult);
											}
										},
                                        minLength: 1
                                });
                        });
                }
              });
	    });	

		$('#vendor-product-number').val($('#vendor-product-fields .row').length);
		
        return false;

    });

    $('form').on('click', 'button[data-toggle=fieldset-remove-row]', function () {
		console.log('Clicked');
		var i = $('#vendor-product-fields .row').length;
		console.log(i);
        if (i > 1) {
			console.log('Unutra');
            $(this).parent().parent().remove();
        }
		$('#vendor-product-number').val($('#vendor-product-fields .row').length);
        return false;
    });
	
});
  
  </script>

  <style>
  .ui-autocomplete {
    max-height: 100px;
    overflow-y: auto;
    /* prevent horizontal scrollbar */
    overflow-x: hidden;
  }
  /* IE 6 doesn't support max-height
   * we use height instead, but this forces the menu to always be this tall
   */
  * html .ui-autocomplete {
    height: 100px;
  }
  #vendor-product-0-remove {
    display: none;
  }
  </style>

{% endblock %}
